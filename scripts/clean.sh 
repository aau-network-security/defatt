#/bin/bash

#!
# todo: will be modified with more dynamic way of cleaning stuff

#request sudo....
if [[ $UID != 0 ]]; then
    echo "Please run this script with sudo:"
    echo "sudo $0 $*"
    exit 1
fi

ovs-vsctl del-br SW
ip tuntap del tap0 mode tap
ip tuntap del tap1 mode tap
ip tuntap del tap2 mode tap
ip tuntap del tap3 mode tap
ip tuntap del tap4 mode tap

VMS=$(vboxmanage list vms | awk '{ print $1 }' | sed -n -e 's/"\([a-z0-9]\{32\}\)"/\1/p')

while read -r line; do
    vm=$(echo $line | cut -d ' ' -f 2)
    echo $vm
    vboxmanage controlvm $vm poweroff
    vboxmanage unregistervm $vm --delete
done <<< "$VMS"

rm -rf /home/${USER}/VirtualBox\ VMs

# Remove all docker containers that have a UUID as name
docker ps -a --format '{{.Names}}' | grep -E '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' | xargs docker rm -f
# Remove all macvlan networks
docker network rm $(docker network ls -q -f )

# Prune entire docker
docker system prune -f

# Prune volumes
docker volume prune -f